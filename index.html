<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Calculate cabin crew salary based on roster data"
    />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Skywage Dashboard</title>
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <!-- Include Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Include Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Authentication is now handled by auth.js -->
  </head>
  <body style="margin: 0; padding: 0; overflow-x: hidden">
    <div class="dashboard-layout">
      <!-- Sidebar -->
      <aside class="dashboard-sidebar">
        <div class="sidebar-logo">
          <i class="fas fa-plane"></i>
        </div>
        <nav class="sidebar-menu">
          <a href="index.html" class="sidebar-menu-item active">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </a>
          <a href="statistics.html" class="sidebar-menu-item">
            <i class="fas fa-chart-bar"></i>
            <span>Statistics</span>
          </a>
          <a href="profile.html" class="sidebar-menu-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
          </a>
          <a href="#" class="sidebar-menu-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </a>
          <a href="#" class="sidebar-menu-item">
            <i class="fas fa-question-circle"></i>
            <span>Help</span>
          </a>
        </nav>
        <div class="sidebar-footer">
          <a href="#" id="sign-out-button">
            <i class="fas fa-sign-out-alt"></i>
            <span>Sign Out</span>
          </a>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="dashboard-content">
        <header class="dashboard-header">
          <h1 class="dashboard-title">
            Dashboard & Calculator
            <span class="text-sm font-normal text-gray-500"
              >(Current Month)</span
            >
          </h1>
          <div class="dashboard-user">
            <div class="dashboard-user-info">
              <div class="dashboard-user-name" id="user-name">
                Welcome back!
              </div>
              <div class="dashboard-user-role" id="user-email">
                user@example.com
              </div>
            </div>
            <div class="dashboard-user-avatar">
              <i class="fas fa-user"></i>
            </div>
          </div>
        </header>

        <!-- Rooms/Categories Section -->
        <div class="mb-6">
          <div class="card-grid">
            <!-- Total Salary Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Total Salary</div>
                <div class="stat-card-icon">
                  <i class="fas fa-coins"></i>
                </div>
              </div>
              <div class="card-content">
                <div class="stat-card-value" id="total-salary">8,275</div>
                <div class="stat-card-label">AED</div>
              </div>
            </div>

            <!-- Variables Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Variables</div>
                <div class="stat-card-icon">
                  <i class="fas fa-plane"></i>
                </div>
              </div>
              <div class="card-content">
                <div class="card-content-row">
                  <span class="card-content-label">Flight Pay:</span>
                  <span class="card-content-value" id="flight-pay">0 AED</span>
                </div>
                <div class="card-content-row">
                  <span class="card-content-label">Per Diem:</span>
                  <span class="card-content-value" id="per-diem">0 AED</span>
                </div>
                <div class="card-content-row">
                  <span class="card-content-label card-content-total"
                    >Total:</span
                  >
                  <span
                    class="card-content-value card-content-total"
                    id="variables-total"
                    >0 AED</span
                  >
                </div>
              </div>
            </div>

            <!-- Flight Hours Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Flight Hours</div>
                <div class="stat-card-icon">
                  <i class="fas fa-clock"></i>
                </div>
              </div>
              <div class="card-content">
                <div class="stat-card-value" id="flight-hours">0:00</div>
                <div class="stat-card-label">Hours</div>
              </div>
            </div>

            <!-- Basic Salary Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Basic Salary</div>
                <div class="stat-card-icon">
                  <i class="fas fa-money-bill-wave"></i>
                </div>
              </div>
              <div class="card-content">
                <div class="stat-card-value" id="basic-salary">8,275</div>
                <div class="stat-card-label">AED</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Section moved to Statistics page -->

        <!-- Month Selector -->
        <div class="mb-4">
          <div
            id="month-selector-container"
            class="p-4 bg-white rounded-lg shadow-md border border-gray-200"
          >
            <!-- Month selector will be populated by JavaScript -->
          </div>
        </div>

        <!-- Flights Table -->
        <div class="table-card">
          <div class="table-card-header">
            <div class="table-card-title">
              Flight Details
              <span
                id="current-month-display"
                class="text-sm font-normal text-gray-500"
              ></span>
            </div>
            <div class="table-card-actions">
              <a
                href="statistics.html"
                class="text-xs text-blue-600 hover:text-blue-800"
                >View Statistics</a
              >
            </div>
          </div>
          <div class="table-container">
            <table class="dashboard-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Duties</th>
                  <th>Details</th>
                  <th>Reporting</th>
                  <th>Debriefing</th>
                  <th>FDP</th>
                  <th>Pay</th>
                </tr>
              </thead>
              <tbody id="recent-flights-table">
                <!-- Flight data will be populated by JavaScript -->
                <tr>
                  <td colspan="7" class="text-center py-4 text-gray-500">
                    No flights data available. Please upload your roster.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Calculator Section -->
        <div class="chart-card mb-6">
          <div class="chart-card-header">
            <div class="chart-card-title">Calculate Your Salary</div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            <!-- Upload Roster Button -->
            <label
              for="csv-upload"
              class="flex flex-col items-center p-6 bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-all cursor-pointer"
            >
              <div class="bg-blue-100 p-4 rounded-full mb-4">
                <i class="fas fa-file-upload text-blue-600 text-2xl"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-700 mb-1">
                Upload Roster
              </h3>
              <p class="text-sm text-gray-500 text-center">
                Import your CSV file
              </p>
              <input id="csv-upload" type="file" accept=".csv" class="hidden" />
            </label>

            <!-- Add Manually Button -->
            <button
              id="add-flight-btn"
              class="flex flex-col items-center p-6 bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-all"
            >
              <div class="bg-green-100 p-4 rounded-full mb-4">
                <i class="fas fa-plus text-green-600 text-2xl"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-700 mb-1">
                Add Manually
              </h3>
              <p class="text-sm text-gray-500 text-center">
                Enter duty details
              </p>
            </button>
          </div>
        </div>

        <!-- Manual Flight Form Container -->
        <div id="manual-flight-form-container" class="chart-card mb-6 hidden">
          <!-- Manual flight entry form will be injected here by JavaScript -->
        </div>

        <!-- Footer -->
        <div
          class="text-center text-gray-500 text-sm mt-10 pt-6 border-t border-gray-200"
        >
          <div class="flex justify-center items-center">
            <i class="fas fa-plane text-blue-400 mr-2"></i>
            <span>© 2025 Skywage - Cabin Crew Salary Calculator</span>
          </div>
          <div class="mt-2 text-xs text-gray-400">
            <a
              href="#"
              class="text-blue-500 hover:text-blue-700 transition-colors"
              >Privacy Policy</a
            >
            |
            <a
              href="#"
              class="text-blue-500 hover:text-blue-700 transition-colors"
              >Terms of Service</a
            >
          </div>
        </div>
      </main>
    </div>

    <!-- JavaScript files -->
    <!-- Core modules -->
    <script src="js/constants.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui-utils.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/calculations.js"></script>
    <script src="js/components.js"></script>

    <!-- Legacy modules -->
    <script src="js/utils.js"></script>
    <script src="js/dataProcessing.js"></script>
    <script src="js/components/flightDetailsTable.js"></script>
    <script src="js/components/flightDetailsCards.js"></script>
    <script src="js/components/monthlySummary.js"></script>
    <script src="js/components/salaryBreakdown.js"></script>
    <script src="js/components/deleteConfirmation.js"></script>
    <script src="js/components/manualFlightEntry.js"></script>
    <script src="js/multiMonthData.js"></script>
    <script src="js/components/multiMonthVisualizations.js"></script>
    <script src="js/components/monthSelector.js"></script>
    <script src="js/dashboard.js"></script>
    <script>
      // Add a timestamp to force refresh: 1714071600000
      // Clear localStorage to ensure we're starting fresh
      function clearLocalStorage() {
        localStorage.removeItem("multiMonthData");
        console.log("Cleared localStorage");
      }

      // Uncomment this line to clear localStorage when needed
      clearLocalStorage(); // Clear localStorage to ensure accurate values

      // Global variable to track the currently selected month
      let selectedMonthKey = "";

      document.addEventListener("DOMContentLoaded", function () {
        // Load multi-month data
        const multiMonthData =
          JSON.parse(localStorage.getItem("multiMonthData")) || {};

        // Get current month data
        const currentDate = new Date();
        const currentMonthKey = `${
          currentDate.getMonth() + 1
        }-${currentDate.getFullYear()}`;

        // Set the selected month to the current month or the first available month
        const availableMonths = Object.keys(multiMonthData);
        if (availableMonths.length > 0) {
          // If there's data for the current month, use it
          if (multiMonthData[currentMonthKey]) {
            selectedMonthKey = currentMonthKey;
          } else {
            // Otherwise, use the most recent month (assuming keys are sorted)
            selectedMonthKey = availableMonths[0];
          }
        } else {
          // If no months available, use the current month
          selectedMonthKey = currentMonthKey;

          // Initialize the current month data structure if it doesn't exist
          if (!multiMonthData[selectedMonthKey]) {
            multiMonthData[selectedMonthKey] = {
              month: getMonthName(currentDate.getMonth() + 1),
              year: currentDate.getFullYear(),
              flights: [],
              calculationResults: {},
            };
            localStorage.setItem(
              "multiMonthData",
              JSON.stringify(multiMonthData)
            );
          }
        }

        // Render the month selector
        window.monthSelector.renderMonthSelector(
          selectedMonthKey,
          "month-selector-container",
          onMonthSelected
        );

        // Update dashboard with the selected month's data
        updateDashboardWithSelectedMonth();

        // Set up event listeners
        setupDashboardEventListeners();
      });

      /**
       * Callback function when a month is selected
       * @param {string} monthKey - The selected month key
       */
      function onMonthSelected(monthKey) {
        console.log("Month selected:", monthKey);
        selectedMonthKey = monthKey;

        // Update the month selector
        window.monthSelector.renderMonthSelector(
          selectedMonthKey,
          "month-selector-container",
          onMonthSelected
        );

        // Update the dashboard with the selected month's data
        updateDashboardWithSelectedMonth();
      }

      /**
       * Updates the dashboard with the selected month's data
       */
      function updateDashboardWithSelectedMonth() {
        // Load multi-month data
        const multiMonthData =
          JSON.parse(localStorage.getItem("multiMonthData")) || {};

        // Get the selected month's data
        const selectedMonthData = selectedMonthKey
          ? multiMonthData[selectedMonthKey] || {
              calculationResults: {},
              flights: [],
            }
          : {
              calculationResults: {},
              flights: [],
            };

        // Update dashboard cards
        updateDashboardCards(selectedMonthData, multiMonthData);

        // Display selected month name
        const currentMonthDisplay = document.getElementById(
          "current-month-display"
        );
        if (currentMonthDisplay) {
          if (selectedMonthKey) {
            // Extract month and year from the key
            const [month, year] = selectedMonthKey.split("-");
            const monthName =
              selectedMonthData.month || getMonthName(parseInt(month));
            currentMonthDisplay.textContent = `(${monthName} ${year})`;
          } else {
            // No month selected
            currentMonthDisplay.textContent = "";
          }
        }
      }

      /**
       * Gets the month name from the month number
       * @param {number} monthNumber - The month number (1-12)
       * @returns {string} The month name
       */
      function getMonthName(monthNumber) {
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        return monthNames[monthNumber - 1] || "Unknown";
      }

      /**
       * Process roster data for a specific month
       * @param {string} csvData - The CSV data to process
       * @param {string} monthKey - The month key to associate the data with
       */
      window.processRosterDataForMonth = function (csvData, monthKey) {
        console.log("Processing roster data for month:", monthKey);

        // Get the user's role from session storage
        const selectedRole =
          sessionStorage.getItem("userPosition") === "sccm" ? "SCCM" : "CCM";

        // Parse the CSV data
        let result;

        if (typeof csvData === "string") {
          // Parse the CSV string using Papa Parse
          const parsedData = Papa.parse(csvData, {
            header: false,
            skipEmptyLines: true,
          }).data;

          // Clean the parsed data if needed
          let cleanedData = parsedData;
          if (
            window.cleanSpecialCharacters &&
            typeof window.cleanSpecialCharacters === "function"
          ) {
            cleanedData = window.cleanSpecialCharacters(parsedData);
          }

          // Process the data using the existing function
          result = window.processRosterData(cleanedData, selectedRole);

          if (result && result.newParsedFlights) {
            // Get multi-month data
            let multiMonthData =
              JSON.parse(localStorage.getItem("multiMonthData")) || {};

            // Create or update the month data
            if (!multiMonthData[monthKey]) {
              multiMonthData[monthKey] = {
                flights: [],
                calculationResults: {},
              };
            }

            // Extract month and year from the key
            const [month, year] = monthKey.split("-");

            // Update with the new data
            multiMonthData[monthKey].flights = result.newParsedFlights;
            multiMonthData[monthKey].calculationResults =
              result.newCalculationResults;
            multiMonthData[monthKey].month = getMonthName(parseInt(month));
            multiMonthData[monthKey].year = parseInt(year);

            // Save to localStorage
            localStorage.setItem(
              "multiMonthData",
              JSON.stringify(multiMonthData)
            );

            // Show success notification
            const monthName = multiMonthData[monthKey].month;
            const yearValue = multiMonthData[monthKey].year;

            if (window.ui && window.ui.showNotification) {
              window.ui.showNotification(
                "success",
                `Roster uploaded successfully for ${monthName} ${yearValue}!`
              );
            } else {
              const notification = document.createElement("div");
              notification.className =
                "fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg";
              notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Roster uploaded successfully for <strong>${monthName} ${yearValue}</strong>!`;
              document.body.appendChild(notification);

              setTimeout(() => {
                notification.remove();
              }, 3000);
            }

            return true;
          } else {
            console.error("Error processing roster data: No flights found");
            window.showErrorNotification(
              "Error processing roster data: No flights found"
            );
            return false;
          }
        } else {
          console.error("Invalid CSV data format");
          window.showErrorNotification("Invalid CSV data format");
          return false;
        }
      };

      // Function to load sample data for testing
      function loadSampleData() {
        console.log("Loading sample data for testing...");
        // Sample CSV data that matches our current_month_roster.csv
        const sampleCsvData = `date,flight,from,to,sector,hours,pay,reporting,debriefing
2024-04-01,FZ123,DXB,IKA,DXB - IKA,5.5,550,08:00,14:30
2024-04-05,FZ456,DXB,KWI,DXB - KWI,3.2,320,10:00,14:12
2024-04-10,FZ789 FZ790,DXB,DXB,DXB - AMM - DXB,4.0,400,07:30,12:30
2024-04-15,FZ234,DXB,MCT,DXB - MCT,2.5,250,09:00,12:30
2024-04-20,LAYOVER FZ567,DXB,BAH,DXB - BAH,2.0,200,14:00,17:00
2024-04-21,LAYOVER FZ568,BAH,DXB,BAH - DXB,2.0,200,10:00,13:00
2024-04-25,ASBY,DXB,DXB,Airport Standby,3.0,150,15:00,18:00`;

        // Process the sample data
        processRosterData(sampleCsvData);
      }

      function updateDashboardCards(currentMonthData, multiMonthData) {
        // Get the user's role
        const selectedRole =
          sessionStorage.getItem("userPosition") === "sccm" ? "SCCM" : "CCM";

        // Calculate fixed components total (for display if no data available)
        const defaultBasicSalary = SALARY_DATA[selectedRole].basicSalary;
        const defaultHousingAllowance =
          SALARY_DATA[selectedRole].housingAllowance;
        const defaultTransportationAllowance =
          SALARY_DATA[selectedRole].transportationAllowance;
        const defaultFixedTotal =
          defaultBasicSalary +
          defaultHousingAllowance +
          defaultTransportationAllowance;

        // Update basic salary (showing the fixed components total)
        const basicSalary =
          currentMonthData.calculationResults?.basicSalary ||
          defaultBasicSalary;
        const housingAllowance =
          currentMonthData.calculationResults?.housingAllowance ||
          defaultHousingAllowance;
        const transportationAllowance =
          currentMonthData.calculationResults?.transportationAllowance ||
          defaultTransportationAllowance;
        const fixedTotal =
          basicSalary + housingAllowance + transportationAllowance;

        const basicSalaryElement = document.getElementById("basic-salary");
        if (basicSalaryElement) {
          basicSalaryElement.textContent = fixedTotal.toLocaleString();
        }

        // Update variables card (Flight Pay and Per Diem)
        // Default to zero until data is uploaded
        const defaultFlightHours = 0;
        const defaultFlightPay = 0;
        const defaultPerDiem = 0;

        // Get values from calculation results
        const flightPay =
          currentMonthData.calculationResults?.flightPay || defaultFlightPay;
        const perDiem =
          currentMonthData.calculationResults?.perDiem || defaultPerDiem;
        const variablesTotal = flightPay + perDiem;

        // Update Flight Pay
        const flightPayElement = document.getElementById("flight-pay");
        if (flightPayElement) {
          flightPayElement.textContent = `${Math.round(
            flightPay
          ).toLocaleString()} AED`;
        }

        // Update Per Diem
        const perDiemElement = document.getElementById("per-diem");
        if (perDiemElement) {
          perDiemElement.textContent = `${Math.round(
            perDiem
          ).toLocaleString()} AED`;
        }

        // Update Variables Total
        const variablesTotalElement =
          document.getElementById("variables-total");
        if (variablesTotalElement) {
          variablesTotalElement.textContent = `${Math.round(
            variablesTotal
          ).toLocaleString()} AED`;
        }

        // Update flight hours
        const flightHours =
          currentMonthData.calculationResults?.totalFlightHours ||
          defaultFlightHours;
        const flightHoursElement = document.getElementById("flight-hours");
        if (flightHoursElement) {
          flightHoursElement.textContent = formatHoursMinutes(flightHours);
        }

        // Update total salary
        // Default to fixed components only (no flight pay until data is uploaded)
        const defaultTotalSalary = defaultFixedTotal;
        const totalSalary =
          currentMonthData.calculationResults?.totalSalary ||
          defaultTotalSalary;
        const totalSalaryElement = document.getElementById("total-salary");
        if (totalSalaryElement) {
          totalSalaryElement.textContent = totalSalary.toLocaleString();
        }

        // Update recent flights table
        updateRecentFlightsTable(currentMonthData.flights || []);
      }

      function updateRecentFlightsTable(flights) {
        console.log("Updating flights table with:", flights);
        const recentFlightsTable = document.getElementById(
          "recent-flights-table"
        );
        if (!recentFlightsTable) {
          console.error("Could not find recent-flights-table element");
          return;
        }

        if (!flights || flights.length === 0) {
          console.log("No flights data available");
          recentFlightsTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-gray-500">No flights data available. Please upload your roster.</td>
                    </tr>
                `;
          return;
        }

        // Get current month and year
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        console.log(`Current month/year: ${currentMonth}/${currentYear}`);

        // For testing purposes, let's show all flights regardless of month
        // This will help us verify that the CSV data is being processed correctly
        const allFlights = [...flights];
        console.log("All flights (unfiltered):", allFlights);

        // TEMPORARY: For testing, show all flights regardless of month
        // This will help us debug the CSV parsing issue
        const currentMonthFlights = flights;
        console.log("Showing all flights for testing:", currentMonthFlights);

        /* COMMENTED OUT FOR TESTING
            // Filter flights for current month
            const currentMonthFlights = flights.filter(flight => {
                // Make sure flight.date is a valid date string
                if (!flight.date) {
                    console.warn('Flight missing date:', flight);
                    return false;
                }

                try {
                    // Parse the date string into a Date object
                    const flightDate = new Date(flight.date);

                    // Check if the date is valid
                    if (isNaN(flightDate.getTime())) {
                        console.warn('Invalid date:', flight.date);
                        return false;
                    }

                    // For testing, let's use the current month from the system
                    // In production, you might want to allow users to select a month
                    const isCurrentMonth = flightDate.getMonth() === currentMonth && flightDate.getFullYear() === currentYear;

                    console.log(`Flight date: ${flight.date}, parsed as: ${flightDate.toISOString()}, is current month: ${isCurrentMonth}`);
                    return isCurrentMonth;
                } catch (e) {
                    console.error('Error parsing flight date:', flight.date, e);
                    return false;
                }
            });
            */

        console.log("Filtered current month flights:", currentMonthFlights);

        // Sort flights by date (chronological order for the month)
        const sortedFlights = [...currentMonthFlights].sort((a, b) => {
          return new Date(a.date) - new Date(b.date);
        });

        // If no flights for current month, show a message
        if (sortedFlights.length === 0) {
          recentFlightsTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-gray-500">No flights found in the uploaded roster.</td>
                    </tr>
                `;
          return;
        }

        // Log the flights we're about to render
        console.log("Flights to render:", JSON.stringify(sortedFlights));

        // Render flights
        recentFlightsTable.innerHTML = sortedFlights
          .map((flight, index) => {
            // Safely handle potentially undefined values
            // Flight hours can be in either hours or flightHours property
            const flightHours = flight.hours || flight.flightHours || 0;
            // Flight pay can be in either pay or flightPay property
            const flightPay = flight.pay || flight.flightPay || 0;

            // Handle different flight data structures
            // dataProcessing.js uses flight.flight for flight number and flight.sector for route
            // while index.html uses flight.flightNumber, flight.departure, and flight.destination
            const flightNumber =
              flight.flightNumber || flight.flight || "Unknown";

            // For the sector/route, check if we have a sector field or need to construct it
            let route = "";

            // First, check if this is a turnaround flight based on the pattern
            // If not already set, detect turnaround flights by checking if departure equals destination
            // or if the sector has a pattern like "DXB - FRU FRU - DXB"
            if (
              !flight.isTurnaround &&
              flight.departure &&
              flight.destination
            ) {
              if (flight.departure === flight.destination) {
                flight.isTurnaround = true;
              }
            }

            if (flight.sector) {
              // Check if this is a turnaround flight with a complex sector string
              if (flight.sector.includes(" - ")) {
                // Extract unique airport codes from the sector string
                let airports = [];

                // Split by " - " to get all segments
                const segments = flight.sector.split(" - ");

                // Process each segment to extract airport codes
                segments.forEach((segment) => {
                  // Clean up any extra text after the airport code
                  const airportCode = segment.trim().split(" ")[0];

                  // Only add unique airport codes
                  if (airportCode && !airports.includes(airportCode)) {
                    airports.push(airportCode);
                  }
                });

                // If we have a complex pattern like "DXB - FRU FRU - DXB", ensure we have the return to origin
                if (
                  airports.length >= 2 &&
                  airports[0] !== airports[airports.length - 1] &&
                  flight.isTurnaround
                ) {
                  airports.push(airports[0]); // Add the origin airport at the end for the return leg
                }

                // If first and last airports are the same, mark as turnaround
                if (
                  airports.length >= 3 &&
                  airports[0] === airports[airports.length - 1]
                ) {
                  flight.isTurnaround = true;
                }

                // Create a simplified route string
                if (airports.length >= 2) {
                  route = airports.join(" - ");
                } else {
                  route = flight.sector; // Fallback to original sector if parsing fails
                }
              } else {
                // Use the sector field directly if not a complex sector
                route = flight.sector;
              }
            } else {
              // Otherwise construct from departure and destination
              route = `${flight.departure || "DXB"} - ${
                flight.destination || "Unknown"
              }`;

              // If this is a turnaround flight, add the return leg
              if (flight.isTurnaround) {
                route = `${flight.departure || "DXB"} - ${
                  flight.destination || "Unknown"
                } - ${flight.departure || "DXB"}`;
              }
            }

            // Check for layover flights based on flight number if not already set
            if (!flight.isLayover && flightNumber) {
              if (flightNumber.toString().toUpperCase().includes("LAY")) {
                flight.isLayover = true;
              }
            }

            // Check for airport standby based on flight number if not already set
            if (!flight.isAsby && flightNumber) {
              if (
                flightNumber.toString().toUpperCase().includes("ASBY") ||
                flightNumber.toString().toUpperCase().includes("STANDBY")
              ) {
                flight.isAsby = true;
              }
            }

            // Log each flight as we render it
            console.log(`Rendering flight ${index}:`, {
              date: flight.date,
              formattedDate: formatDate(flight.date),
              flightNumber: flightNumber,
              route: route,
              hours: flightHours,
              pay: flightPay,
            });

            // Define different arrow SVGs for different flight types
            const standardArrowSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mx-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>`;

            const layoverArrowSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-1 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;

            const turnaroundArrowSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-1 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>`;

            // Prepare flight type display
            let flightTypeDisplay = "";
            let routeDisplay = "";

            // Determine flight type and create appropriate display
            if (flight.isTurnaround) {
              // Turnaround flight - teal with sync icon
              flightTypeDisplay = `<span class="ml-2 px-2 py-1 bg-teal-100 text-teal-800 rounded-full text-xs flex items-center" style="display: inline-flex;"><i class="fas fa-sync-alt mr-1"></i>Turnaround</span>`;

              // For turnaround flights, check if it's a simple origin-destination-origin pattern
              if (
                route.split(" - ").length === 3 &&
                route.split(" - ")[0] === route.split(" - ")[2]
              ) {
                const airports = route.split(" - ");
                routeDisplay = `
                        <span class="font-medium">${airports[0]}</span>
                        <span class="text-teal-500">${turnaroundArrowSvg}</span>
                        <span class="font-medium">${airports[1]}</span>
                    `;
              } else {
                // For more complex routes, use the standard display
                routeDisplay = route
                  .split(" - ")
                  .map(
                    (airport, i, arr) =>
                      `<span class="font-medium">${airport}</span>` +
                      (i < arr.length - 1
                        ? `<span class="text-teal-500">${standardArrowSvg}</span>`
                        : "")
                  )
                  .join("");
              }
            } else if (flight.isLayover) {
              // Layover flight - purple with bed icon
              flightTypeDisplay = `<span class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs flex items-center" style="display: inline-flex;"><i class="fas fa-bed mr-1"></i>Layover</span>`;

              // For layover flights, use the one-way arrow
              const airports = route.split(" - ");
              if (airports.length === 2) {
                routeDisplay = `
                        <span class="font-medium">${airports[0]}</span>
                        <span class="text-indigo-500">${layoverArrowSvg}</span>
                        <span class="font-medium">${airports[1]}</span>
                    `;
              } else {
                routeDisplay = route;
              }
            } else if (flight.isAsby) {
              // Airport standby - yellow with clock icon
              flightTypeDisplay = `<span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs flex items-center" style="display: inline-flex;"><i class="fas fa-clock mr-1"></i>ASBY</span>`;
              routeDisplay = route;
            } else {
              // Regular flight - gray with plane icon
              flightTypeDisplay = `<span class="ml-2 px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs flex items-center" style="display: inline-flex;"><i class="fas fa-plane mr-1"></i>Flight</span>`;

              // For regular flights, use the standard arrow
              const airports = route.split(" - ");
              if (airports.length === 2) {
                routeDisplay = `
                        <span class="font-medium">${airports[0]}</span>
                        <span class="text-gray-500">${standardArrowSvg}</span>
                        <span class="font-medium">${airports[1]}</span>
                    `;
              } else {
                routeDisplay = route;
              }
            }

            return `
                <tr>
                    <td>${formatDate(flight.date)}</td>
                    <td>
                        <div class="flex items-center">
                            <span>${flightNumber}</span>
                            ${flightTypeDisplay}
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center">
                            ${routeDisplay}
                        </div>
                    </td>
                    <td>${
                      flight.reporting && flight.reporting !== 0
                        ? flight.reporting
                        : "N/A"
                    }</td>
                    <td>${
                      flight.debriefing && flight.debriefing !== 0
                        ? flight.debriefing
                        : "N/A"
                    }</td>
                    <td>${
                      typeof flightHours === "number" && flightHours > 0
                        ? formatHoursMinutes(flightHours)
                        : "N/A"
                    }</td>
                    <td>${
                      typeof flightPay === "number" && flightPay > 0
                        ? Math.round(flightPay) + " AED"
                        : "N/A"
                    }</td>
                </tr>
                `;
          })
          .join("");

        // Update the count in the header
        const flightCountElement = document.querySelector(
          ".table-card-actions span"
        );
        if (flightCountElement) {
          flightCountElement.textContent = `${sortedFlights.length} flights`;
        } else {
          // If the count element doesn't exist, create it
          const actionsDiv = document.querySelector(".table-card-actions");
          if (actionsDiv) {
            const countSpan = document.createElement("span");
            countSpan.className =
              "text-xs bg-blue-100 text-blue-800 py-1 px-2 rounded-full ml-2";
            countSpan.textContent = `${sortedFlights.length} flights`;
            actionsDiv.appendChild(countSpan);
          }
        }
      }

      function formatDate(dateString) {
        try {
          let date;

          // Check if the date is in the format DD/MM/YYYY Day (e.g., 01/11/2024 Fri)
          if (
            typeof dateString === "string" &&
            dateString.match(/^\d{2}\/\d{2}\/\d{4}\s+[A-Za-z]{3}$/)
          ) {
            // Extract just the date part (remove the day of week)
            const datePart = dateString.split(" ")[0];
            const [day, month, year] = datePart.split("/");
            // Create date in YYYY-MM-DD format
            date = new Date(`${year}-${month}-${day}`);
          } else {
            // Try standard parsing
            date = new Date(dateString);
          }

          // Check if the date is valid
          if (isNaN(date.getTime())) {
            console.warn("Invalid date in formatDate:", dateString);
            return "Invalid date";
          }

          // Format as DD/MM/YY Weekday (e.g., 21/04/25 Mon)
          const day = date.getDate().toString().padStart(2, "0");
          const month = (date.getMonth() + 1).toString().padStart(2, "0");
          const year = date.getFullYear().toString().slice(-2); // Get last 2 digits
          const weekday = date
            .toLocaleDateString("en-GB", { weekday: "short" })
            .slice(0, 3);

          return `${day}/${month}/${year} ${weekday}`;
        } catch (e) {
          console.error("Error formatting date:", dateString, e);
          return "Error";
        }
      }

      function processFlightData(data) {
        console.log("Processing flight data:", data.slice(0, 3));

        // Transform the data into our flight format
        const flights = data.map((row) => {
          console.log("Processing row:", row);

          // Create a proper date object from the date string
          let flightDate = row.date;
          if (flightDate) {
            // Ensure the date is in YYYY-MM-DD format
            if (flightDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
              // Already in correct format
            } else if (flightDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
              // Convert from MM/DD/YYYY to YYYY-MM-DD
              const parts = flightDate.split("/");
              flightDate = `${parts[2]}-${parts[0].padStart(
                2,
                "0"
              )}-${parts[1].padStart(2, "0")}`;
            }
          } else {
            // Default to today if no date
            flightDate = new Date().toISOString().split("T")[0];
          }

          // Log all row keys and values for debugging
          console.log("Row keys:", Object.keys(row));
          console.log("Row values:", Object.values(row));

          // Try to find the correct field names by checking all possible variations
          let flightNumberField = Object.keys(row).find(
            (key) =>
              (key.toLowerCase().includes("flight") &&
                key.toLowerCase().includes("number")) ||
              key.toLowerCase() === "flight" ||
              key.toLowerCase() === "flightno" ||
              key.toLowerCase() === "flightnumber"
          );

          let departureField = Object.keys(row).find(
            (key) =>
              key.toLowerCase() === "departure" ||
              key.toLowerCase() === "from" ||
              key.toLowerCase() === "origin"
          );

          let destinationField = Object.keys(row).find(
            (key) =>
              key.toLowerCase() === "destination" ||
              key.toLowerCase() === "to" ||
              key.toLowerCase() === "dest"
          );

          let hoursField = Object.keys(row).find(
            (key) =>
              (key.toLowerCase().includes("flight") &&
                key.toLowerCase().includes("hour")) ||
              key.toLowerCase() === "hours" ||
              key.toLowerCase() === "flighttime" ||
              key.toLowerCase() === "flighthours"
          );

          let payField = Object.keys(row).find(
            (key) =>
              (key.toLowerCase().includes("flight") &&
                key.toLowerCase().includes("pay")) ||
              key.toLowerCase() === "pay" ||
              key.toLowerCase() === "payment" ||
              key.toLowerCase() === "flightpay"
          );

          let dateField = Object.keys(row).find(
            (key) =>
              key.toLowerCase() === "date" ||
              key.toLowerCase() === "flightdate" ||
              key.toLowerCase() === "dutydate"
          );

          let reportingTimeField = Object.keys(row).find(
            (key) =>
              key.toLowerCase().includes("reporting") ||
              key.toLowerCase() === "reportingtime" ||
              key.toLowerCase() === "report"
          );

          let debriefingTimeField = Object.keys(row).find(
            (key) =>
              key.toLowerCase().includes("debriefing") ||
              key.toLowerCase() === "debriefingtime" ||
              key.toLowerCase() === "debrief"
          );

          console.log("Found fields:", {
            flightNumberField,
            departureField,
            destinationField,
            hoursField,
            payField,
            dateField,
            reportingTimeField,
            debriefingTimeField,
          });

          // Create the flight object with all necessary properties
          const flight = {
            date: dateField ? row[dateField] : flightDate,
            flightNumber: flightNumberField
              ? row[flightNumberField]
              : "Unknown",
            departure: departureField ? row[departureField] : "DXB",
            destination: destinationField ? row[destinationField] : "Unknown",
            reporting: reportingTimeField ? row[reportingTimeField] : 0,
            debriefing: debriefingTimeField ? row[debriefingTimeField] : 0,
            // Calculate flight hours and pay
            flightHours: hoursField ? parseFloat(row[hoursField]) : 0,
            flightPay: payField ? parseFloat(row[payField]) : 0,
          };

          // Set flight type flags
          // Construct sector string if not already present
          if (!flight.sector) {
            flight.sector = `${flight.departure} - ${flight.destination}`;
          }

          // Check if this is a layover flight (based on flight number pattern or other indicators)
          flight.isLayover = false;
          if (flightNumberField && row[flightNumberField]) {
            // Check if flight number contains indicators of layover
            const flightNum = row[flightNumberField].toString().toUpperCase();
            if (flightNum.includes("LAYOVER") || flightNum.includes("LAY")) {
              flight.isLayover = true;
            }
          }

          // Check if this is a turnaround flight (based on sector pattern)
          flight.isTurnaround = false;
          if (flight.sector && flight.sector.includes(" - ")) {
            const segments = flight.sector.split(" - ");
            // If there are 3 or more segments and first equals last, it's likely a turnaround
            if (
              segments.length >= 3 &&
              segments[0] === segments[segments.length - 1]
            ) {
              flight.isTurnaround = true;
            }
            // Or if there are exactly 2 segments but the second contains the first airport code
            else if (
              segments.length === 2 &&
              segments[1].includes(segments[0])
            ) {
              flight.isTurnaround = true;
            }
          }

          // Check if this is an airport standby
          flight.isAsby = false;
          if (flightNumberField && row[flightNumberField]) {
            const flightNum = row[flightNumberField].toString().toUpperCase();
            if (flightNum.includes("ASBY") || flightNum.includes("STANDBY")) {
              flight.isAsby = true;
            }
          }

          // Validate the flight object
          if (isNaN(flight.flightHours)) flight.flightHours = 0;
          if (isNaN(flight.flightPay)) flight.flightPay = 0;

          // Log the created flight object
          console.log("Created flight object:", flight);

          // Log the mapping from CSV to flight object
          console.log("CSV to Flight mapping:", {
            flight:
              (flightNumberField ? row[flightNumberField] : "N/A") +
              " → " +
              flight.flightNumber,
            from:
              (departureField ? row[departureField] : "N/A") +
              " → " +
              flight.departure,
            to:
              (destinationField ? row[destinationField] : "N/A") +
              " → " +
              flight.destination,
            hours:
              (hoursField ? row[hoursField] : "N/A") +
              " → " +
              flight.flightHours,
            pay: (payField ? row[payField] : "N/A") + " → " + flight.flightPay,
          });

          // Dump the entire row and flight object for debugging
          console.log("Raw row data:", JSON.stringify(row));
          console.log("Final flight object:", JSON.stringify(flight));

          return flight;
        });

        // Get current month data from localStorage or create new
        const currentDate = new Date();
        const currentMonthKey = `${
          currentDate.getMonth() + 1
        }-${currentDate.getFullYear()}`;
        const multiMonthData =
          JSON.parse(localStorage.getItem("multiMonthData")) || {};

        // Create or update the current month data
        if (!multiMonthData[currentMonthKey]) {
          multiMonthData[currentMonthKey] = {
            flights: [],
            calculationResults: {},
          };
        }

        // Add the new flights to the current month data
        multiMonthData[currentMonthKey].flights = flights;

        // Calculate totals
        const totalFlightHours = flights.reduce(
          (sum, flight) => sum + flight.flightHours,
          0
        );
        const totalFlightPay = flights.reduce(
          (sum, flight) => sum + flight.flightPay,
          0
        );

        // Get the user's role from session storage
        const selectedRole =
          sessionStorage.getItem("userPosition") === "sccm" ? "SCCM" : "CCM";

        // Calculate the complete salary using all components
        const basicSalary = SALARY_DATA[selectedRole].basicSalary;
        const housingAllowance = SALARY_DATA[selectedRole].housingAllowance;
        const transportationAllowance =
          SALARY_DATA[selectedRole].transportationAllowance;

        // Get per diem and standby pay from calculation results if available
        // Otherwise default to 0
        const perDiem = currentMonthData.calculationResults?.perDiem || 0;
        const asbyPay = currentMonthData.calculationResults?.asbyPay || 0;

        // Calculate total salary with all fixed components
        const totalSalary =
          basicSalary +
          housingAllowance +
          transportationAllowance +
          totalFlightPay +
          perDiem +
          asbyPay;

        // Update calculation results
        multiMonthData[currentMonthKey].calculationResults = {
          basicSalary: basicSalary,
          housingAllowance: housingAllowance,
          transportationAllowance: transportationAllowance,
          flightPay: totalFlightPay,
          perDiem: perDiem,
          asbyPay: asbyPay,
          totalFlightHours: totalFlightHours,
          totalSalary: totalSalary,
        };

        // Save to localStorage
        localStorage.setItem("multiMonthData", JSON.stringify(multiMonthData));

        // Update the dashboard
        updateDashboardCards(multiMonthData[currentMonthKey], multiMonthData);

        // Show a success notification instead of an alert
        const notification = document.createElement("div");
        notification.className =
          "fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg";
        notification.textContent = "Roster uploaded successfully!";
        document.body.appendChild(notification);

        // Remove the notification after 3 seconds
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Helper function to show error notifications
      window.showErrorNotification = function (message) {
        // Use ui-utils if available
        if (window.ui && window.ui.showNotification) {
          window.ui.showNotification("error", message, 5000);
        } else {
          // Fallback to old method
          const notification = document.createElement("div");
          notification.className =
            "fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-md shadow-lg";
          notification.textContent = message;
          document.body.appendChild(notification);

          // Remove the notification after 5 seconds
          setTimeout(() => {
            notification.remove();
          }, 5000);
        }
      };

      function setupDashboardEventListeners() {
        // Sign out button
        const signOutButton = document.getElementById("sign-out-button");
        if (signOutButton) {
          signOutButton.addEventListener("click", function (e) {
            e.preventDefault();
            sessionStorage.removeItem("isAuthenticated");
            sessionStorage.removeItem("userPosition");
            sessionStorage.removeItem("userEmail");
            window.location.href = "sign-in.html";
          });
        }

        // Set user email
        const userEmail = sessionStorage.getItem("userEmail");
        const userEmailElement = document.getElementById("user-email");
        if (userEmailElement && userEmail) {
          userEmailElement.textContent = userEmail;
        }

        // Add flight button
        const addFlightBtn = document.getElementById("add-flight-btn");
        if (addFlightBtn) {
          addFlightBtn.addEventListener("click", function () {
            const formContainer = document.getElementById(
              "manual-flight-form-container"
            );
            if (formContainer) {
              formContainer.classList.remove("hidden");
              // Here you would normally call a function to render the form
              // For demo purposes, we'll just add a placeholder
              formContainer.innerHTML = `
                            <div class="chart-card-header">
                                <div class="chart-card-title">Add Flight Manually</div>
                            </div>
                            <div class="p-4">
                                <form id="manual-flight-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                        <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Flight Number</label>
                                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g. FZ123">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Departure</label>
                                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g. DXB">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
                                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g. IKA">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Reporting Time</label>
                                        <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Debriefing Time</label>
                                        <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="md:col-span-2 mt-4">
                                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                            Add Flight
                                        </button>
                                    </div>
                                </form>
                            </div>
                        `;
            }
          });
        }

        // CSV upload
        const csvUpload = document.getElementById("csv-upload");
        if (csvUpload) {
          csvUpload.addEventListener("change", function (e) {
            try {
              console.log("File input change event triggered");

              // Check if files exist
              if (!e.target.files) {
                console.error("No files property on event target");
                window.showErrorNotification(
                  "No file selected. Please try again."
                );
                return;
              }

              // Check if any files were selected
              if (e.target.files.length === 0) {
                console.error("No files selected");
                window.showErrorNotification(
                  "No file selected. Please try again."
                );
                return;
              }

              // Get the file
              const file = e.target.files[0];

              // Validate file
              if (!file) {
                console.error("File is null or undefined");
                window.showErrorNotification("Invalid file. Please try again.");
                return;
              }

              // Check file type
              if (
                file.type &&
                !file.type.match("text/csv") &&
                !file.type.match("application/vnd.ms-excel") &&
                !file.type.match("text/plain")
              ) {
                console.error("File type not supported:", file.type);
                window.showErrorNotification(
                  "File type not supported. Please upload a CSV file."
                );
                return;
              }

              // Check file size (limit to 5MB)
              if (file.size > 5 * 1024 * 1024) {
                console.error("File too large:", file.size);
                window.showErrorNotification(
                  "File too large. Please upload a smaller file (max 5MB)."
                );
                return;
              }

              // Log file details
              console.log("Selected file:", file.name, file.type, file.size);

              // Show a loading notification
              const loadingNotification = document.createElement("div");
              loadingNotification.className =
                "fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-md shadow-lg";
              loadingNotification.textContent = "Processing roster file...";
              document.body.appendChild(loadingNotification);

              // Create a new FileReader
              const reader = new FileReader();

              // Set up onload handler
              reader.onload = function (event) {
                try {
                  console.log("FileReader onload event triggered");

                  // Check if result exists
                  if (!event.target || !event.target.result) {
                    console.error("No result in FileReader event");
                    loadingNotification.remove();
                    window.showErrorNotification(
                      "Error reading file content. Please try again."
                    );
                    return;
                  }

                  // Ensure we have a string
                  const csvData = event.target.result;
                  if (typeof csvData !== "string") {
                    console.error(
                      "FileReader result is not a string:",
                      typeof csvData
                    );
                    window.showErrorNotification(
                      "Error: Invalid file format. Please ensure you are uploading a text-based CSV file."
                    );
                    return;
                  }

                  console.log(
                    "CSV data loaded, type:",
                    typeof csvData,
                    "length:",
                    csvData.length
                  );
                  console.log("First 100 chars:", csvData.substring(0, 100));

                  // Remove the loading notification
                  loadingNotification.remove();

                  // Process using the specialized function for flydubai format
                  console.log("Processing flydubai roster format...");

                  // Clean the CSV data to handle potential encoding issues
                  const cleanedCsvData = csvData.replace(/[^\x00-\x7F]/g, ""); // Remove non-ASCII characters
                  console.log(
                    "Cleaned CSV data length:",
                    cleanedCsvData.length
                  );

                  // Parse the CSV data using Papa Parse
                  Papa.parse(cleanedCsvData, {
                    header: false, // Don't use header for flydubai format
                    skipEmptyLines: true,
                    complete: function (results) {
                      console.log(
                        "CSV parsed successfully, rows:",
                        results.data.length
                      );
                      console.log("First few rows:", results.data.slice(0, 10));

                      // Clean the parsed data to handle special characters
                      if (
                        window.cleanSpecialCharacters &&
                        typeof window.cleanSpecialCharacters === "function"
                      ) {
                        console.log(
                          "Cleaning special characters from parsed data"
                        );
                        results.data = window.cleanSpecialCharacters(
                          results.data
                        );
                      }

                      if (results.data && results.data.length > 0) {
                        // Get the user's role from session storage
                        const selectedRole =
                          sessionStorage.getItem("userPosition") === "sccm"
                            ? "SCCM"
                            : "CCM";
                        console.log("User role:", selectedRole);

                        try {
                          // Process the data using the function from dataProcessing.js
                          console.log(
                            "Calling processRosterData with",
                            results.data.length,
                            "rows"
                          );

                          // Make sure we're passing the data correctly
                          let result;
                          if (Array.isArray(results.data)) {
                            console.log(
                              "Results data is an array, passing directly"
                            );
                            result = window.processRosterData(
                              results.data,
                              selectedRole
                            );
                          } else {
                            console.error(
                              "Results data is not an array:",
                              typeof results.data
                            );
                            window.showErrorNotification(
                              "Error: Invalid data format"
                            );
                            return;
                          }

                          console.log("processRosterData returned:", result);

                          if (result && result.newParsedFlights) {
                            console.log(
                              "Processed flights:",
                              result.newParsedFlights.length
                            );

                            if (result.newParsedFlights.length === 0) {
                              console.error(
                                "No flights were parsed from the roster data"
                              );
                              window.showErrorNotification(
                                "No flights found in the roster. Please check the file format."
                              );
                              return;
                            }

                            // Use the selected month key instead of the roster's month
                            // This associates the uploaded roster with the currently selected month
                            const monthKey = selectedMonthKey;
                            console.log("Using selected month key:", monthKey);
                            let multiMonthData =
                              JSON.parse(
                                localStorage.getItem("multiMonthData")
                              ) || {};

                            // Create or update the month data
                            if (!multiMonthData[monthKey]) {
                              multiMonthData[monthKey] = {
                                flights: [],
                                calculationResults: {},
                              };
                            }

                            // Update with the new data
                            multiMonthData[monthKey].flights =
                              result.newParsedFlights;
                            multiMonthData[monthKey].calculationResults =
                              result.newCalculationResults;
                            multiMonthData[monthKey].month =
                              result.newRosterMonth;
                            multiMonthData[monthKey].year =
                              result.newRosterYear;

                            // Save to localStorage
                            localStorage.setItem(
                              "multiMonthData",
                              JSON.stringify(multiMonthData)
                            );
                            console.log("Saved data to localStorage");

                            // Update the dashboard with the selected month's data
                            updateDashboardWithSelectedMonth();

                            // Update the month selector to reflect any changes
                            window.monthSelector.renderMonthSelector(
                              selectedMonthKey,
                              "month-selector-container",
                              onMonthSelected
                            );

                            // Extract month and year from the key for the notification
                            const [month, year] = monthKey.split("-");
                            const monthName =
                              multiMonthData[monthKey].month ||
                              getMonthName(parseInt(month));

                            // Show success notification using ui-utils if available
                            if (window.ui && window.ui.showNotification) {
                              window.ui.showNotification(
                                "success",
                                `Roster uploaded successfully for ${monthName} ${year}!`
                              );
                            } else {
                              // Fallback to old method
                              const notification =
                                document.createElement("div");
                              notification.className =
                                "fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg";
                              notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Roster uploaded successfully for <strong>${monthName} ${year}</strong>!`;
                              document.body.appendChild(notification);

                              // Remove the notification after 3 seconds
                              setTimeout(() => {
                                notification.remove();
                              }, 3000);
                            }
                          } else {
                            console.error(
                              "processRosterData returned null or no flights"
                            );
                            window.showErrorNotification(
                              "Error processing roster data. No flights found."
                            );
                          }
                        } catch (processError) {
                          console.error(
                            "Error in processRosterData:",
                            processError
                          );
                          window.showErrorNotification(
                            "Error processing roster data: " +
                              processError.message
                          );
                        }
                      } else {
                        console.error(
                          "No valid data found in the parsed results"
                        );
                        window.showErrorNotification(
                          "No valid data found in the file."
                        );
                      }
                    },
                    error: function (error) {
                      console.error("Papa Parse error:", error);
                      window.showErrorNotification(
                        "Error parsing CSV file: " + error.message
                      );
                    },
                  });
                } catch (err) {
                  console.error("Error in FileReader onload handler:", err);
                  loadingNotification.remove();
                  window.showErrorNotification(
                    "Error processing file: " + err.message
                  );
                }
              };

              // Set up onerror handler
              reader.onerror = function (event) {
                console.error("FileReader error event:", event);
                console.error(
                  "FileReader error code:",
                  reader.error ? reader.error.code : "unknown"
                );

                // Remove the loading notification if it exists
                if (loadingNotification.parentNode) {
                  loadingNotification.remove();
                }

                // Show an error notification
                window.showErrorNotification(
                  "Error reading the file. Please try again."
                );
              };

              // Start reading the file
              console.log("Starting to read file as text...");
              reader.readAsText(file);
              console.log("ReadAsText called successfully");
            } catch (err) {
              console.error("Error in file upload handler:", err);
              window.showErrorNotification(
                "Error processing file: " + err.message
              );
            }
          });
        }
      }
    </script>
  </body>
</html>
